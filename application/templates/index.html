<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Impedance Analyzer</title>


        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

        <link rel="stylesheet" href="{{ url_for('static', filename='nyquist.css') }}">

        <style media="screen">

        /************** Customize NavBar ******************/
        .navbar-custom {
            margin-bottom: 0px;
            background-color: #009688;
            color:#009688;
        }

        /*  Link colors     */
        .navbar-custom .navbar-nav > li > a {
          	color:#fff;
            font-weight: bold;
        }

        .navbar-custom .navbar-nav > .active > a, .navbar-nav > .active > a:hover, .navbar-nav > .active > a:focus {
            color: #fff;
        	background-color:transparent;
        }

        /* Hover background */
        .navbar-custom .navbar-nav > li > a:hover, .nav > li > a:focus {
            text-decoration: none;
            background-color: #B2DFDB;
            color: #FF5722;
            font-weight: bold;
        }

        .navbar-custom .navbar-brand {
          	color:#fff;
            font-weight: bold;
        }
        .navbar-custom .navbar-toggle {
          	background-color:#eeeeee;
        }
        .navbar-custom .icon-bar {
          	background-color:#009688;
        }

        /*@media (min-width:768px){
            .navbar-custom .navbar-nav > li:last-child {
                border-left:2px solid #fff;
            }
        }*/
        /************* End Customize NavBar **************/

        html, body {
            height:100%;
        }

        /* Medium devices (desktops, 992px and up) */
        @media screen and (min-device-width: 992px) {
            #first-row {
                height: 30%;
            }

            #second-row {
                height: 70%;
            }
        }

        div #grid-impedance, #grid-parameters,
        #grid-introduction, #grid-load {
            height: 100%;
            background-color: #FFFFFF;
            border: 2px #BDBDBD solid;
            padding: 0px 10px;
            overflow-y: auto;;
            }

        div #grid-impedance {
            overflow: hidden;
        }

        .glyphicon-question-sign {
            font-size: .5em;
            vertical-align: top;
        }

        .btn-browse {
            background-color: #80cbc4;
        }

        .btn-plot {

            transition: all 0.3s ease 0s;
            background-color: #FF5722;
            font-weight: bold;
            color: #FFFFFF;
        }

        .btn-plot:hover:enabled {
            transition: all 0.3s ease 0s;
            background-color: #FF5722;
            font-weight: bold;
            color: #FFFFFF;
            -webkit-transform: scale(1.2);
            -ms-transform: scale(1.2);
            transform: scale(1.2);
        }

        .ec-fit {
          fill: none;
          stroke: #FF5722;
          stroke-width: 2px;
        }

        .p2d-fit {
          fill: none;
          stroke: #000;
          stroke-width: 2px;
        }

        .default-circle {
            fill: #009688;
        }

        .selected-circle {
            fill: #FF5722;
        }

        .label {
            font-size: 1em;
        }

        .tooltip {
            position: absolute;;
            height: 28px;
            pointer-events: none;
            position: absolute;
            text-align: left;
            padding: 7px;
            font: 12px sans-serif;
            background: lightsteelblue;
            opacity: .7;
            border: 0px;
            border-radius: 12px;
        }

        .navbar-fixed-bottom {
            min-height: 40px;
            background-color: #80cbc4;
            /*border-top: 1px solid #BDBDBD;*/
        }

        @media screen and (max-width: 992px) {
            #grid-parameters { padding-bottom: 40px; }
        }

        .button rect {
          stroke: #ff5722;
          stroke-width: 1px;
        }

        .button #gradient-start {
        /*  stop-color: #3498db; */
          stop-color: #ff5722; /* 70% */
          stop-opacity: 1;
        }

        .button #gradient-stop {
        /*  stop-color: #2980b9; */
          stop-color: #ff5722; /* 100% */
          stop-opacity: 1;
        }

        .button #gradient-start.active {
        /*  stop-color: #3cb0fd; */
          stop-color: #ff5722; /* 40% */
        }

        .button #gradient-stop.active {
        /*  stop-color: #3498db; */
          stop-color: #ff5722; /* 70% */
        }

        .button text {
          font-size: 1em;
          fill: #eee;
          pointer-events: none;
          text-anchor: middle;
          -moz-user-select: none;
          -webkit-user-select: none;
          -ms-user-select: none;
        }

        @keyframes spinner {
            to {transform: rotate(360deg);}
        }

        .spinner:before {
            content: '';
            box-sizing: border-box;
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            margin-top: -10px;
            margin-left: -10px;
            border-radius: 50%;
            border: 5px solid #f6f;
            border-top-color: #0e0;
            border-right-color: #0dd;
            border-bottom-color: #f90;
            animation: spinner .9s ease infinite;
        }

        .axis line, .axis path {
            shape-rendering: crispEdges;
            stroke: black;
            fill: none;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 11px;
        }

        div.explore-tooltip {
            position: absolute;
            text-align: left;
            padding: 7px;
            font: 12px sans-serif;
            background: lightsteelblue;
            opacity: .7;
            border: 0px;
            border-radius: 12px;
        }

        </style>

    </head>
    <body>
        <!-- <a href="https://your-url" class="github-corner" aria-label="View source on Github"><svg width="50" height="50" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; z-index:1; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style> -->
        <!-- <a class="github-corner" target="_blank" href="https://github.com/vshivam"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0; z-index:1"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path><text class="github-corner-text" text-anchor="middle" x="175" y="30" transform="rotate(45)" font-size="32" font-weight="bold">Fork me on Github</text></svg></a><style>.github-corner:hover .octo-arm{animation: octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%, 100%{transform: rotate(0)}20%, 60%{transform: rotate(-25deg)}40%, 80%{transform: rotate(10deg)}}@media (max-width: 500px){.github-corner:hover .octo-arm{animation: none}.github-corner .octo-arm{animation: octocat-wave 560ms ease-in-out}.github-corner-text{display: none;}.github-corner svg{height: 50px; width: 50px;}}</style> -->

        <!-- Header -->
        <nav class="navbar navbar-static-top navbar-custom">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#">Impedance Analyzer</a>
                </div>
                <div id="navbar" class="collapse navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="{{ url_for('index')}}">Home</a></li>
                        <li><a href="#demo">Demo</a></li>
                        <li><a target="_blank" href="http://impedanceanalyzer.readthedocs.io/en/latest/">Docs</a></li>
                    </ul>
                </div><!--/.nav-collapse -->
            </div>
        </nav>

        <!-- Modal for defining Equivalent Circuit-->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" onclick="uncheckEC();" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Define your equivalent circuit</h4>
                    </div>
                    <div class="modal-body">
                        <p class="danger">Note: only Randles w/ CPE currently works</p>
                        <ul class="nav nav-tabs" role="tablist">
                            <!-- <li role="presentation" class="nav active"><a href="#randles" role="tab" data-toggle="tab" onclick="initializeEC();"><img src="{{ url_for('static', filename='images/randles.png') }}" alt="" /></a></li> -->
                            <li role="presentation" class="nav"><a href="#randles_cpe" role="tab" data-toggle="tab" onclick="initializeEC();"><img src="{{ url_for('static', filename='images/randles_cpe.png') }}" alt="" /></a></li>
                            <li role="presentation" class="nav"><a href="#self_define" role="tab" data-toggle="tab" onclick="initializeEC();"><p style="text-align: center; font-weight: bold;">Define <br> custom <br> circuit</p></a></li>
                        </ul>
                        <div class="tab-content" id="ECtab">
                            <!-- <div class="tab-pane active" id="randles">
                                <form class="form-horizontal" action="" id="defineECparam">
                                    <div class="form-group">
                                        <label for="R1" class="col-sm-2 control-label">R1</label>
                                            <div class="col-sm-8 input-group">
                                                <input type="text" name="R1" value="0.01" class="form-control">
                                                <div class="input-group-addon">Ohms</div>
                                            </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="R2" class="col-sm-2 control-label">R2</label>
                                            <div class="col-sm-8 input-group">
                                                <input type="text" name="R2" value="0.01" class="form-control">
                                                <div class="input-group-addon">Ohms</div>
                                            </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="W1" class="col-sm-2 control-label">W1</label>
                                            <div class="col-sm-8 input-group">
                                                <input type="text" name="W1" value=".01" class="form-control">
                                                <div class="input-group-addon">Ohms</div>
                                            </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="W2" class="col-sm-2 control-label">W2</label>
                                            <div class="col-sm-8 input-group">
                                                <input type="text" name="W2" value="10" class="form-control">
                                                <div class="input-group-addon">Ohms</div>
                                            </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="C1" class="col-sm-2 control-label">C1</label>
                                            <div class="col-sm-8 input-group">
                                                <input type="text" name="C1" value="0.01" class="form-control" >
                                                <div class="input-group-addon">F</div>
                                            </div>
                                    </div>
                                </form>
                            </div> -->
                            <div class="tab-pane active" id="randles_cpe">
                                <form class="form-horizontal" action="" id="defineECparam">
                                    <div class="form-group">
                                        <label for="R1" class="col-sm-2 control-label">R1</label>
                                            <div class="col-sm-8 input-group">
                                                <input type="text" name="R1" value="0.01" class="form-control">
                                                <div class="input-group-addon">Ohms</div>
                                            </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="R2" class="col-sm-2 control-label">R2</label>
                                            <div class="col-sm-8 input-group">
                                                <input type="text" name="R2" value="0.01" class="form-control">
                                                <div class="input-group-addon">Ohms</div>
                                            </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="W1" class="col-sm-2 control-label">W1</label>
                                            <div class="col-sm-8 input-group">
                                                <input type="text" name="W1" value=".01" class="form-control">
                                                <div class="input-group-addon">Ohms</div>
                                            </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="W2" class="col-sm-2 control-label">W2</label>
                                            <div class="col-sm-8 input-group">
                                                <input type="text" name="W2" value="10" class="form-control">
                                                <div class="input-group-addon">Ohms</div>
                                            </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="C1" class="col-sm-2 control-label">C1</label>
                                            <div class="col-sm-8 input-group">
                                                <input type="text" name="C1" value="0.01" class="form-control" >
                                                <div class="input-group-addon">F</div>
                                            </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="C2" class="col-sm-2 control-label">C2</label>
                                            <div class="col-sm-8 input-group">
                                                <input type="text" name="C2" value="0.8" class="form-control">
                                                <div class="input-group-addon"></div>
                                            </div>
                                    </div>
                                </form>
                            </div>
                            <div class="tab-pane" id="self_define">
                                TODO:
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">Save changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Explore Fit Modal -->
        <div class="modal fade" id="exploreFitModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Modal title</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div id="explore-residuals"></div>
                            </div>
                            <div class="col-md-6">
                                <div id="explore-nyquist"></div>
                            </div>
                        </div>
                    <!-- <iframe src="mseviz" width="800" height="300" frameBorder="0" style="overflow: hidden"></iframe> -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container-fluid" style="height: calc(100% - 90px);">
            <div class="row" id="first-row">
                <div class="col-md-3" id="grid-introduction">
                    <a target="_blank" href="https://github.com/mdmurbach/ImpedanceAnalyzer"><img style="position: absolute; top: 0; right: 0; border: 0; z-index: 1; height: 80px;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>
                    <div class="" style="padding-right: 80px;">
                        <h4> Welcome to the Impedance Analyzer: </h4>
                    </div>
                    <h5>an open-source tool for analyzing EIS data.</h5>
                </div>
                <div class="col-md-9"  id="grid-load">
                    <h4>Upload a file<i id="info-fileupload" class="glyphicon glyphicon-question-sign" data-toggle="tooltip" title="Additional information" aria-hidden="true"></i> or choose an example</h3>
                    <form style="padding: 20px;" class="" method=POST enctype=multipart/form-data action="{{ url_for('index') }}" id="fileinput">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="fileselectbutton"> Select File </label>
                                    <input style="display: none;" type="file" name="data" id="fileselect" />
                                    <input class="btn btn-browse form-control" type="button" value="Browse..." onclick="document.getElementById('fileselect').click();" id="fileselectbutton">
                                    <button class="btn" onclick="reset($('#fileselect'))"><span aria-hidden="true">&times; remove file</span></button></input>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="exampleselect">
                                        Select Example Dataset
                                    </label>
                                    <select class="form-control" name="example" id="exampleselect">
                                        <option value="null">Select a dataset</option>
                                        <!-- <option value="zhang_example.csv">Zhang, 2000</option> -->
                                        <option value="imp-data.csv">EIS data</option>
                                        <option value="wu_example.csv">Wu</option>
                                        <option value="samsung_example.csv">Samsung NMC</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Model(s) to fit: </label>
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" id="ecinput" name="fitting-ec" value="ec" onchange="ecdefine();"/>Equivalent Circuit
                                            <button type="button" id="ecmodal" style="display: none;" data-toggle="modal" data-target="#myModal" onclick="initializeEC();"></button>
                                        </label>
                                    </div>
                                    <div class="checkbox">
                                        <label style="">
                                            <input type="checkbox" name="fitting-p2d" value="p2d"/>Pseudo 2-Dimensional
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <input class="btn btn-plot pull-right" disabled="disabled" type="submit" onclick="submitECparams()" value="Plot" id="plot" >
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="row" id="second-row">
                <div class="col-md-8" id="grid-impedance">
                    <div class="row" style="height: 100%">
                        <div id="loadingDiv" class="spinner"></div>
                        <div class="col-md-6" style="height: 100%">
                                <div id="bode" style="height: 100%"></div>
                        </div>
                        <div class="col-md-6" style="height: 100%">
                            <div id="nyquist" style="height: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4" id="grid-parameters">
                    <h4>  Parameter Estimates<i class="glyphicon glyphicon-question-sign" id="info-parameters" data-toggle="tooltip" title="Additional information" aria-hidden="true"></i></h3>
                    <ul class="nav nav-tabs" role="tablist">
                        {% if ec_parameters %}
                        <li role="presentation" class="nav active"><a href="#ec_param" aria-controls="EC parameters" role="tab" data-toggle="tab">EC</a></li>
                        {% endif %}
                        {% if p2d_parameters %}
                        <li role="presentation" class="nav"><a href="#p2d_param" aria-controls="P2D parameters" role="tab" data-toggle="tab">P2D</a></li>
                        {% endif %}
                    </ul>
                    <div class="tab-content">
                        {% if ec_parameters %}
                        <div class="tab-pane fade in active" id="ec_param">
                            <div class="table-responsive" id="table-div">
                                <table class="table" id="parameter-estimates">
                                    <tr>
                                        <th>
                                            Parameter
                                        </th>
                                        <th>
                                            Best Estimate
                                        </th>
                                        <th data-toggle="tooltip" title="The error is given as the estimated one-sigma standard deviation">
                                            Error
                                        </th>
                                    </tr>
                                    {% for parameter in ec_parameters %}
                                        <tr>
                                            <td><p>{{ parameter.name }}</p></td>
                                            <td>{{ parameter.value }}</td>
                                            <td>{{ parameter.sensitivity }}</td>
                                        </tr>
                                    {% endfor %}
                                </table>
                            </div>
                        </div>
                        {% endif %}
                        {% if p2d_parameters %}
                        <div class="tab-pane fade" id="p2d_param">
                            <div class="table-responsive" id="table-div">
                                <table class="table" id="parameter-estimates">
                                    <tr>
                                        <th>
                                            Parameter
                                        </th>
                                        <th>
                                            Best Estimate
                                        </th>
                                        <th>
                                            Sensitivity
                                        </th>
                                    </tr>
                                    {% for parameter in p2d_parameters %}
                                        <tr>
                                            <td><p>{{ parameter.name }}</p></td>
                                            <td>{{ parameter.value }}</td>
                                            <td>{{ parameter.sensitivity }}</td>
                                        </tr>
                                    {% endfor %}
                                </table>
                            </div>
                        </div>
                        {% endif %}
                </div>
            </div>

        </div>

        <nav class="navbar navbar-default navbar-fixed-bottom">
            <div class="container.fluid">
                <img class="" src="{{ url_for('static', filename='images/W.png') }}" alt="CEI logo" style="height: 30px; margin: 5px 10px;">
                <img class="pull-right" src="{{ url_for('static', filename='images/CEI_logo_tag_color.png') }}" alt="CEI logo" style="height: 30px; margin: 5px 10px;">
                <img class="pull-right" src="{{ url_for('static', filename='images/IGERT.png') }}" alt="CEI logo" style="height: 30px; margin: 5px 10px;">
            </div>
        </nav>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

        <script type="text/javascript">
        var $loading = $('#loadingDiv').hide();
        $(document)
            .ajaxStart(function () {
            $loading.show();
            })
            .ajaxStop(function () {
                $loading.hide();
            });
        </script>

        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

        <!-- d3 -->
        <script src="https://d3js.org/d3.v3.min.js"></script>

        <!-- submit form -->
        <script type="text/javascript">
        function submitECparams() {
            $('#loadingDiv').show();

            var inputs = $('#ECtab .tab-pane.active #defineECparam :input');
            inputs.each(function() {
                $(this).appendTo('#fileinput');
                $(this).hide();
            });

        }
        </script>

        <script type="text/javascript">
            function initializeEC() {
                var inputs = $('#ECtab #defineECparam :input');
                inputs.each(function() {
                    $(this).show();
                });
            }
        </script>

        <script type="text/javascript">
            function uncheckEC() {
                $('#ecinput').prop('checked', false);
            }
        </script>

        <!-- file input button -->
        <script type="text/javascript">
        $('#fileselect').on('change', function() {
            $('#fileselectbutton').val($(this).val());
            $('#plot').prop('disabled', false);
            $('#modelFieldset').removeProp('disabled');
        });
        $('#exampleselect').on('change', function() {
            $('#plot').prop('disabled', false);
            $('#modelFieldset').removeProp('disabled');
        });
        window.reset = function (e) {
            e.wrap('<form>').closest('form').get(0).reset();
            e.unwrap();
        }
        </script>

        <!-- bootstrap tooltips -->
        <!-- TODO: Add tooltip help here -->
        <script type="text/javascript">
        $('#info-fileupload').prop('title', 'TODO: The uploaded .csv file will be interpreted with the first column as frequency, second column as real impedance, third column as imaginary impedance.')
        $('#info-parameters').prop('title', 'Error indicates estimated standard deviation of fit parameters');
        </script>

        <script type="text/javascript">
        $(function () {
            $('[data-toggle="tooltip"]').tooltip({ placement: 'bottom'})
        })
        </script>

        <!-- define equivalent circuit -->
        <script type="text/javascript">
        function ecdefine() {
            if($('#ecinput').is(':checked')) {
                document.getElementById('ecmodal').click();
            }
        }
        </script>

        <!-- add svg button -->
        <script type="text/javascript" src="{{ url_for('static', filename='button.js') }}"> </script>

        <!-- draw Nyquist with d3 -->
        <script type="text/javascript" src="{{ url_for('static', filename='nyquist-models.js') }}"> </script>

        <script type="text/javascript">
            var data = {{ data|tojson|safe }}; // 1 x N frequencys Array of 1 x 3 arrays (real, imag, freq)
            if (data == 0) {
                d3.select('#nyquist')
            	.append('div')
            	.text('<-- Upload a file')
            } else {
                var ecmodel = {{ ecFit|tojson|safe }};
                var p2dmodel = {{ p2dFit|tojson|safe }};

                outerWidth = d3.select('#bode').node().getBoundingClientRect().width;
                outerHeight = d3.select('#bode').node().getBoundingClientRect().height;

                var nyquist = nyquistChart({width: outerWidth, height: outerHeight, ec: ecmodel, p2d: p2dmodel})
                    .x(function(d) { return d[1] })
                    .y(function(d) { return -d[2] });

                d3.select("#nyquist")
                    .datum(data)
                    .call(nyquist);

                if (p2dmodel) {
                    var svg = d3.select("#nyquist svg")

                    var g = svg.append('g')
                        .attr('class', 'button')
                        .attr('transform', 'translate(' + outerWidth*.75 + ',' + outerHeight*.1 + ')')

                    var text = g.append('text')
                        .text('Explore P2D Fit')

                    button()
                        .container(g)
                        .text(text)
                        .count(0)
                        .cb(function() { $('#exploreFitModal').modal('show') })();
                }

            }
        </script>

        <script type="text/javascript">
            var sorted_results = {{ p2d_residuals|tojson|safe }};
            var simulations = {{ p2d_simulations|tojson|safe }};

            outerWidth = $(window).width();
            outerHeight = $(window).height()*.5;

            console.log(simulations);
            // console.log("height: " + outerHeight);
            // console.log("width: " + outerWidth);

            var svg_res = d3.select('#explore-residuals').append("svg")
            var svg_nyq = d3.select('#explore-nyquist').append("svg")

            var margin = {top: 10, right: 10, bottom: 60, left: 60};
            var width = outerWidth/3 - margin.left - margin.right;
            var height = outerHeight - margin.top - margin.bottom;

            var xScale_res = d3.scale.linear()
            var yScale_res = d3.scale.linear()

            var xScale_nyq = d3.scale.linear()
            var yScale_nyq = d3.scale.linear()

            var xAxis_res = d3.svg.axis()
                .scale(xScale_res)
                .ticks(5)
                .orient('bottom');

            var yAxis_res = d3.svg.axis()
                .scale(yScale_res)
                .ticks(5)
                .orient('left');

            xScale_res
                .range([0, width])
                .domain(d3.extent(sorted_results, function(d, i) { return i} ));

            yScale_res
                .range([height, 0])
                .domain(d3.extent(sorted_results, function(d, i) { return d[2]} ));

            var plot_res = svg_res.append("g");
            var plot_nyq = svg_nyq.append("g");

            plot_res.append("g").attr("class", "x axis");
            plot_res.append("g").attr("class", "y axis");

            // Update the outer dimensions.
            svg_res
                .attr("width", outerWidth/3)
                .attr("height", outerHeight);

            svg_nyq
                .attr("width", d3.min([outerWidth/3, outerHeight]))
                .attr("height", d3.min([outerWidth/3, outerHeight]));

            var g_res = svg_res.select("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var g_nyq = svg_nyq.select("g")
                .attr("transform", "translate(" + margin.left + "," + (margin.top) +  ")");

            // var tooltip_ph = g_ph.append("div")
            //     .attr("class", "tooltip")
            //     .style("opacity", 0);
            //
            // var tooltip_mag = g_mag.append("div")
            //     .attr("class", "tooltip")
            //     .style("opacity", 0);

            g_res.select(".x.axis")
                .attr('transform', 'translate(0,' + height + ')')
                .call(xAxis_res)

            g_res.select(".y.axis")
                .attr('transform', 'translate(0,' + 0 + ')')
                .call(yAxis_res)


            g_res.append("text")
                .attr("class", "label")
                .attr("transform", "translate(" + (width/2) + " ," +
                                                (height + margin.bottom - 10) + ")")
                .style("text-anchor", "middle")
                .text("Number #");

            g_res.append("text")
                .attr("class", "label")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left - 0)
                .attr("x",0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Avg. % Error");

            var div = d3.select("#explore-residuals").append("div")
                .attr("class", "explore-tooltip")
                .style("opacity", 0);

            var residuals = g_res.selectAll("circle").data(sorted_results);

            residuals.enter().append('circle');
            residuals
                .attr("class", "default-circle")
                .attr("cx", function (d, i) { return xScale_res(i); } )
                .attr("cy", function (d) { return yScale_res(d[2]); } )
                .attr("r", 5)
                .on("mouseover", function(d, i) {
                    impedance = simulations.find( function(data) { return data[0] == d[0]; });
                    scale = d[1];
                    plot_impedance(impedance, scale)

                    d3.select(this).style("fill", "red")

                    div.transition()
                        .duration(200)
                        .style("opacity", 1);

                    div.html(
                        'Rank: ' + (i+1) + '<br>' +
                        'MSE:  ' + Math.round(d[2] * 1000)/ 1000  + '%'  + '<br>' +
                        'Run: '+ d[0])
                        .style("left", width + "px")
                        .style("top", (height-20) + "px");
                    })
                    .on("mouseout", function(d) {
                        d3.select(this).transition().duration(150).style("fill", "#009688");
                    });

            initialize_impedance();

            function plot_impedance(data, scale) {
                impedance = [];

                data[1].split(',').forEach(function(d,i) {
                    impedance[i] = {
                        f: +d,
                        real: +data[2].split(',')[i],
                        imag: -1*(+data[3].split(',')[i])
                    }
                })

                impedances = g_nyq.selectAll(".circles").data(impedance)

                // define the line
                var line = d3.svg.line()
                    .x(function(d) { return xScale_nyq(scale*d.real); })
                    .y(function(d) { return yScale_nyq(scale*d.imag); });

                g_nyq.selectAll("path")
                  .datum(impedance)
                  .attr("class", "p2d-fit")
                  .transition().duration(100)
                  .attr("d", line);

                impedances
                        .enter().append("circle")
                        .attr("class", "circles")
                        .attr("r", 5)

                impedances
                        .transition().duration(100)
                        .attr("cx", function(d) {return xScale_nyq(scale*d.real)})
                        .attr("cy", function(d) { return yScale_nyq(scale*d.imag)})

                impedances
                    .exit().remove();

                };

                function initialize_impedance() {

                    var data = {{ data|tojson|safe }};

                    plot_nyq.append("g").attr("class", "x axis");
                    plot_nyq.append("g").attr("class", "y axis");

                    max = d3.max( [d3.max(data, function(d, i) { return d[1]} ) - d3.min(data, function(d, i) { return d[1]} ),
                                            d3.max(data, function(d, i) { return -d[2]} ) - d3.min(data, function(d, i) { return -d[2]} )]);

                    xScale_nyq
                        .range([0, d3.min([outerWidth/3, outerHeight]) - margin.left - margin.right ])
                        .domain([ d3.min(data, function(d, i) { return d[1]} ) - max*.1,  d3.min(data, function(d, i) { return d[1]} ) + max*1.4]);

                    yScale_nyq
                        .range([d3.min([outerWidth/3, outerHeight]) - margin.top - margin.bottom , 0])
                        .domain([0, max*1.5]);

                    var xAxis_nyq = d3.svg.axis()
                        .scale(xScale_nyq)
                        .ticks(5)
                        .orient('bottom');

                    var yAxis_nyq = d3.svg.axis()
                        .scale(yScale_nyq)
                        .ticks(5)
                        .orient('left');

                    g_nyq.select(".x.axis")
                        .attr('transform', 'translate(0,' + height + ')')
                        .call(xAxis_nyq)

                    g_nyq.select(".y.axis")
                        .attr('transform', 'translate(0,' + 0 + ')')
                        .call(yAxis_nyq)

                    g_nyq.append("text")
                        .attr("class", "label")
                        .attr("transform", "translate(" + (width/2) + " ," +
                                                        (height + margin.bottom - 10) + ")")
                        .style("text-anchor", "middle")
                        .text("Z' [Ohms]");

                    g_nyq.append("text")
                        .attr("class", "label")
                        .attr("transform", "rotate(-90)")
                        .attr("y", -margin.left - 1)
                        .attr("x",0 - (height / 2))
                        .attr("dy", "1em")
                        .style("text-anchor", "middle")
                        .text("-Z'' [Ohms]");

                    var nyquist = g_nyq.selectAll("circle").data(data);

                    nyquist.enter().append('circle');
                    nyquist
                        .attr("class", "default-circle")
                        .attr("cx", function (d, i) { return xScale_nyq(d[1]); } )
                        .attr("cy", function (d) { return yScale_nyq(-d[2]); } )
                        .attr("r", 5)

                }

        </script>

        <!-- draw bode plot  with d3 -->
        <script type="text/javascript">
            var data = {{ data|tojson|safe }}; // 1 x N frequencys Array of 1 x 3 arrays (real, imag, freq)

            function phase(real, imag) {
                return Math.atan2(imag,real)*180/Math.PI;
            }

            function mag(real, imag) {
                return Math.sqrt(Math.pow(imag, 2) + Math.pow(real, 2));
            }

            if (data == 0) {
                d3.select('#bode')
            	.append('div')
            	.text('<-- Upload a file')
            } else {
                var ecmodel = {{ ecFit|tojson|safe }};
                var p2dmodel = {{ p2dFit|tojson|safe }};

                outerWidth = d3.select('#bode').node().getBoundingClientRect().width;
                outerHeight = d3.select('#bode').node().getBoundingClientRect().height;

                console.log(outerHeight);

                var margin = {top: outerHeight*.01, right: outerWidth*.01, bottom: outerHeight*.12, left: outerWidth*.12};
                var width = outerWidth - margin.left - margin.right;
                var height = outerHeight/2 - margin.top - margin.bottom;

                var xScale_ph = d3.scale.log()
                var yScale_ph = d3.scale.linear()

                var xScale_mag = d3.scale.log()
                var yScale_mag = d3.scale.log()

                var xAxis_ph = d3.svg.axis()
                    .scale(xScale_ph)
                    .ticks(5)
                    .orient('bottom');

                var yAxis_ph = d3.svg.axis()
                    .scale(yScale_ph)
                    .ticks(5)
                    .orient('left');

                var xAxis_mag = d3.svg.axis()
                    .scale(xScale_mag)
                    .ticks(5)
                    .orient('bottom');

                var yAxis_mag = d3.svg.axis()
                    .scale(yScale_mag)
                    .ticks(5)
                    .orient('left');

                xScale_ph
                    .range([0, width])
                    .domain(d3.extent(data, function(d, i) { return d[0]} ));

                yScale_ph
                    .range([height, 0])
                    .domain([0, d3.min(data, function(d, i) { return phase(d[1], d[2])} )]);

                xScale_mag
                    .range([0, width])
                    .domain(d3.extent(data, function(d, i) { return d[0]} ));

                yScale_mag
                    .range([height, 0])
                    .domain(d3.extent(data, function(d, i) { return mag(d[1], d[2])} ))
                    .nice();

                // Select the svg element, if it exists.
                var svg_ph = d3.select('#bode').append("svg").attr("id", "phase")
                var svg_mag = d3.select('#bode').append("svg").attr("id", "magnitude")


                var plot_ph = svg_ph.append("g");
                var plot_mag = svg_mag.append("g");

                plot_ph.append("g").attr("class", "x axis");
                plot_ph.append("g").attr("class", "y axis");

                plot_mag.append("g").attr("class", "x axis");
                plot_mag.append("g").attr("class", "y axis");

                // Update the outer dimensions.
                svg_ph
                    .attr("width", outerWidth)
                    .attr("height", outerHeight/2);

                svg_mag
                    .attr("width", outerWidth)
                    .attr("height", outerHeight/2);

                var g_ph = svg_ph.select("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var g_mag = svg_mag.select("g")
                    .attr("transform", "translate(" + margin.left + "," + (margin.top) +  ")");

                var tooltip_ph = g_ph.append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);

                var tooltip_mag = g_mag.append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);

                g_ph.select(".x.axis")
                    .attr('transform', 'translate(0,' + height + ')')
                    .call(xAxis_ph)

                g_ph.select(".y.axis")
                    .attr('transform', 'translate(0,' + 0 + ')')
                    .call(yAxis_ph)

                g_mag.select(".x.axis")
                    .attr('transform', 'translate(0,' + height + ')')
                    .call(xAxis_mag)

                g_mag.select(".y.axis")
                    .attr('transform', 'translate(0,' + 0 + ')')
                    .call(yAxis_mag)

                g_ph.append("text")
                    .attr("class", "label")
                    .attr("transform", "translate(" + (width/2) + " ," +
                                                    (height + margin.bottom - 10) + ")")
                    .style("text-anchor", "middle")
                    .text("Frequency [Hz]");

                g_ph.append("text")
                    .attr("class", "label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left - 1)
                    .attr("x",0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("-Phase [deg]");

                g_mag.append("text")
                    .attr("class", "label")
                    .attr("transform", "translate(" + (width/2) + " ," +
                                                    (height + margin.bottom - 10) + ")")
                    .style("text-anchor", "middle")
                    .text("Frequency [Hz]");

                g_mag.append("text")
                    .attr("class", "label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left - 1)
                    .attr("x",0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("Magnitude [Ohms]");

                var phases = g_ph.selectAll("circle").data(data);

                phases.enter().append('circle');
                phases
                    .attr("class", "default-circle")
                    .attr("cx", function (d) { return xScale_ph( d[0] ); } )
                    .attr("cy", function (d) { return yScale_ph( phase(d[1], d[2]) ); } )
                    .attr("r", 5)
                    .on("mouseover", function(d,i) {
                        d3.select(this)
                            .classed("selected-circle", true)
                            .attr("r", 10);

                        g_mag.selectAll("circle")
                            .data(data)
                            .classed("selected-circle", function(d2, i2) {return i2 == i; })
                            .attr("r", function(d2, i2) { if(i2 == i) { return 10; } else { return 5;} });

                        d3.select("#nyquist").selectAll("circle")
                            .data(data)
                            .classed("selected-circle", function(d2, i2) {return i2 == i; })
                            .attr("r", function(d2, i2) { if(i2 == i) { return 10; } else { return 5;} });

                        tooltip_ph.transition()
                            .duration(200)
                            .style("opacity", .9);

                        tooltip_ph.html('Freq: ' + Math.round(d[0]*1000)/1000 + "<br/>"  +
                                            'Phase: ' + Math.round(phase(d[1], d[2])*1000)/1000)
                                            .style("left", 30 + "px")
                                            .style("top", 30 + "px");

                    })
                    .on("mouseout", function(d,i) {
                        d3.select(this)
                            .attr("class", "default-circle")
                            .attr("r", 5);

                        g_mag.selectAll("circle")
                            .data(data)
                            .attr("class", "default-circle")
                            .attr("r", 5);

                        d3.select("#nyquist").selectAll("circle")
                            .data(data)
                            .attr("class", "default-circle")
                            .attr("r", 5);
                    });

                var mags = g_mag.selectAll("circle").data(data);

                mags.enter().append('circle');
                mags
                    .attr("class", "default-circle")
                    .attr("cx", function (d) { return xScale_mag( d[0] ); } )
                    .attr("cy", function (d) { return yScale_mag( mag(d[1], d[2]) );  } )
                    .attr("r", 5)
                    .on("mouseover", function(d,i) {
                        d3.select(this)
                            .classed("selected-circle", true)
                            .attr("r", 10);

                        // console.log(phases);
                        g_ph.selectAll("circle")
                            .data(data)
                            .classed("selected-circle", function(d2, i2) {return i2 == i; })
                            .attr("r", function(d2, i2) { if(i2 == i) { return 10; } else { return 5;} });

                        d3.select("#nyquist").selectAll("circle")
                            .data(data)
                            .classed("selected-circle", function(d2, i2) {return i2 == i; })
                            .attr("r", function(d2, i2) { if(i2 == i) { return 10; } else { return 5;} });

                        // tooltip.transition()
                        //     .duration(200)
                        //     .style("opacity", .9);
                        //
                        // tooltip.html('Freq: ' + Math.round(d[0]*1000)/1000 + "<br/>"  +
                        //                     'Mag: ' + Math.round(mag(d[1], d[2])*1000)/1000)
                        //                     .style("left", (outerWidth - 30) + "px")
                        //                     .style("top", outerHeight*3/4 + "px");

                    })
                    .on("mouseout", function(d,i) {
                        d3.select(this)
                            .attr("class", "default-circle")
                            .attr("r", 5);

                        g_ph.selectAll("circle")
                            .data(data)
                            .attr("class", "default-circle")
                            .attr("r", 5);

                        d3.select("#nyquist").selectAll("circle")
                            .data(data)
                            .attr("class", "default-circle")
                            .attr("r", 5);

                    });

                    //  Add model fit if exists
                    if(ecmodel.length > 0) {

                        var line_ph = d3.svg.line()
                            .x(function(d) { return xScale_ph( d[0] ); })
                            .y(function(d) { return yScale_ph(phase(d[1], d[2])); });

                        g_ph.append("path")
                              .datum(ecmodel)
                              .attr("class", "ec-fit")
                              .attr("d", line_ph);

                        var line_mag = d3.svg.line()
                            .x(function(d) { return xScale_mag( d[0] ); })
                            .y(function(d) { return yScale_mag(mag(d[1], d[2])); });

                        g_mag.append("path")
                            .datum(ecmodel)
                            .attr("class", "ec-fit")
                            .attr("d", line_mag);
                    }

                    //  Add model fit if exists
                    if(p2dmodel.length > 0) {

                        var line_ph = d3.svg.line()
                            .x(function(d) { return xScale_ph( d[0] ); })
                            .y(function(d) { return yScale_ph(phase(d[1], d[2])); });

                        g_ph.append("path")
                              .datum(p2dmodel)
                              .attr("class", "p2d-fit")
                              .attr("d", line_ph);

                        var line_mag = d3.svg.line()
                            .x(function(d) { return xScale_mag( d[0] ); })
                            .y(function(d) { return yScale_mag(mag(d[1], d[2])); });

                        g_mag.append("path")
                            .datum(p2dmodel)
                            .attr("class", "p2d-fit")
                            .attr("d", line_mag);
                    }

            }
        </script>

    </body>
</html>
