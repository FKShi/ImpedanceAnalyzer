<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Impedance Analyzer</title>


        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

        <link rel="stylesheet" href="{{ url_for('static', filename='nyquist.css') }}">

        <style media="screen">

        /************** Customize NavBar ******************/
        .navbar-custom {
            margin-bottom: 0px;
            background-color: #009688;
            color:#009688;
        }

        /*  Link colors     */
        .navbar-custom .navbar-nav > li > a {
          	color:#fff;
            font-weight: bold;
        }

        .navbar-custom .navbar-nav > .active > a, .navbar-nav > .active > a:hover, .navbar-nav > .active > a:focus {
            color: #fff;
        	background-color:transparent;
        }

        /* Hover background */
        .navbar-custom .navbar-nav > li > a:hover, .nav > li > a:focus {
            text-decoration: none;
            background-color: #B2DFDB;
            color: #FF5722;
            font-weight: bold;
        }

        .navbar-custom .navbar-brand {
          	color:#fff;
            font-weight: bold;
        }
        .navbar-custom .navbar-toggle {
          	background-color:#eeeeee;
        }
        .navbar-custom .icon-bar {
          	background-color:#009688;
        }

        /*@media (min-width:768px){
            .navbar-custom .navbar-nav > li:last-child {
                border-left:2px solid #fff;
            }
        }*/
        /************* End Customize NavBar **************/

        html, body {
            height:100%;
        }

        /* Medium devices (desktops, 992px and up) */
        @media screen and (min-device-width: 992px) {
            #first-row {
                height: 30%;
            }

            #second-row {
                height: 70%;
            }
        }

        div #grid-impedance, #grid-parameters,
        #grid-introduction, #grid-load {
            height: 100%;
            background-color: #FFFFFF;
            border: 2px #BDBDBD solid;
            padding: 0px 10px;
            overflow-y: auto;;
            }

        div #grid-impedance {
            overflow: hidden;
        }

        .glyphicon-question-sign {
            font-size: .5em;
            vertical-align: top;
        }

        .btn-browse {
            background-color: #80cbc4;
        }

        .btn-plot {

            transition: all 0.3s ease 0s;
            background-color: #FF5722;
            font-weight: bold;
            color: #FFFFFF;
        }

        .btn-plot:hover:enabled {
            transition: all 0.3s ease 0s;
            background-color: #FF5722;
            font-weight: bold;
            color: #FFFFFF;
            -webkit-transform: scale(1.2);
            -ms-transform: scale(1.2);
            transform: scale(1.2);
        }

        .randles-fit {
          fill: none;
          stroke: #FF5722;
          stroke-width: 2px;
        }

        .two_constant_warburg-fit {
          fill: none;
          stroke: #03A9F4;
          stroke-width: 2px;
        }

        .p2d-fit {
            fill: none;
            stroke: #000;
            stroke-width: 2px;
        }

        .randles-legend {
            stroke: #FF5722;
            font-family: monospace;
        }

        .two_constant_warburg-legend {
            stroke: #03A9F4;
            font-family: monospace;
        }

        .p2d-legend {
            stroke: #000;
            font-family: monospace;
        }

        .default-circle {
            fill: #009688;
        }

        .selected-circle {
            fill: #FF5722;
        }

        .label {
            font-size: 1em;
        }

        .tooltip {
            position: absolute;;
            height: 28px;
            pointer-events: none;
            position: absolute;
            text-align: left;
            padding: 7px;
            font: 12px sans-serif;
            background: lightsteelblue;
            opacity: .7;
            border: 0px;
            border-radius: 12px;
        }

        .navbar-fixed-bottom {
            min-height: 40px;
            background-color: #80cbc4;
            /*border-top: 1px solid #BDBDBD;*/
        }

        @media screen and (max-width: 992px) {
            #grid-parameters { padding-bottom: 40px; }
        }

        .button rect {
          stroke: #ff5722;
          stroke-width: 1px;
        }

        .button #gradient-start {
        /*  stop-color: #3498db; */
          stop-color: #ff5722; /* 70% */
          stop-opacity: 1;
        }

        .button #gradient-stop {
        /*  stop-color: #2980b9; */
          stop-color: #ff5722; /* 100% */
          stop-opacity: 1;
        }

        .button #gradient-start.active {
        /*  stop-color: #3cb0fd; */
          stop-color: #ff5722; /* 40% */
        }

        .button #gradient-stop.active {
        /*  stop-color: #3498db; */
          stop-color: #ff5722; /* 70% */
        }

        .button text {
          font-size: 1em;
          fill: #eee;
          pointer-events: none;
          text-anchor: middle;
          -moz-user-select: none;
          -webkit-user-select: none;
          -ms-user-select: none;
        }

        @keyframes spinner {
            to {transform: rotate(360deg);}
        }

        .spinner:before {
            content: '';
            box-sizing: border-box;
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            margin-top: -10px;
            margin-left: -10px;
            border-radius: 50%;
            border: 5px solid #f6f;
            border-top-color: #0e0;
            border-right-color: #0dd;
            border-bottom-color: #f90;
            animation: spinner 1.0s ease infinite;
        }

        .axis line, .axis path {
            shape-rendering: crispEdges;
            stroke: black;
            fill: none;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 11px;
        }

        div.explore-tooltip {
            position: absolute;
            text-align: left;
            padding: 7px;
            font: 12px sans-serif;
            background: lightsteelblue;
            opacity: .7;
            border: 0px;
            border-radius: 12px;
        }

        div.checkbox {
            padding-left: 5px;
        }

        .btn-next, .btn-save {
            margin-right: 20px;
        }

        label.disabled {
            color: #757575;
        }

        #grid-parameters ul {
            font-size: .8em;
        }

        #exploreFitModal-dialog {
            width: 98%;
            height: 92%;
            padding: 0;
        }

        #exploreFitModal-content {
            height: 99%;
        }

        table#parameter-estimates,
        table#parameter-estimates th {
            text-align: center;
        }

        </style>

    </head>
    <body>

        <!-- Header -->
        <nav class="navbar navbar-static-top navbar-custom">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#">Impedance Analyzer</a>
                </div>
                <div id="navbar" class="collapse navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="{{ url_for('index')}}">Home</a></li>
                        <li><a href="#demo">Demo</a></li>
                        <li><a target="_blank" href="http://impedanceanalyzer.readthedocs.io/en/latest/">Docs</a></li>
                    </ul>
                </div><!--/.nav-collapse -->
            </div>
        </nav>

        <!-- Modal for defining options based on selected analyses-->
        <div class="modal fade" id="modal-analysis" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" onclick="uncheckEC();" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Input options for model fits</h4>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs" role="tablist">
                            <!-- Auto populated from circuits variable below -->
                        </ul>
                        <div class="tab-content" id="ECtab">
                            <!-- Auto populated from circuits variable below-->
                        </div>
                    </div>
                    <div class="modal-footer">

                    </div>
                </div>
            </div>
        </div>

        <!-- Explore Fit Modal -->
        <div class="modal fade" id="exploreFitModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog modal-lg" role="document" id="exploreFitModal-dialog">
                <div class="modal-content" id="exploreFitModal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Explore P2D fit</h4>
                    </div>
                    <div class="modal-body" style="height: calc(100% - 120px);">
                        <div class="row" style="height: 100%">
                            <div class="col-md-4">
                                <div id="explore-residuals"></div>
                            </div>
                            <div class="col-md-4">
                                <div id="explore-nyquist"></div>
                            </div>
                            <div class="col-md-4" style="height: 100%">
                                <div class="table-responsive" id="table-div" style="height: 100%">
                                    <table class="table table-condensed" id="parameter-estimates" style="height: 100%; overflow-y: auto">
                                        <tbody>
                                            <tr>
                                                <th>Parameter</th>
                                                <th>Units</th>
                                                <th>Value</th>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container-fluid" style="height: calc(100% - 90px);">
            <div class="row" id="first-row">
                <div class="col-md-3" id="grid-introduction">
                    <a target="_blank" href="https://github.com/mdmurbach/ImpedanceAnalyzer"><img style="position: absolute; top: 0; right: 0; border: 0; z-index: 1; height: 80px;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>
                    <div class="" style="padding-right: 80px;">
                        <h4> Welcome to the Impedance Analyzer: </h4>
                    </div>
                    <h5>an open-source tool for analyzing EIS data.</h5>
                </div>
                <div class="col-md-9"  id="grid-load" style="overflow-y: visible">
                    <h4>Upload a file<i id="info-fileupload" class="glyphicon glyphicon-question-sign" data-toggle="tooltip" title="Additional information" aria-hidden="true"></i> or choose an example</h3>
                    <form style="padding: 20px;" class="" method=POST enctype=multipart/form-data action="{{ url_for('index') }}" id="selection-form">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="selection-form_upload-btn"> Select a file to upload </label>
                                    <input style="display: none;" type="file" name="data" id="selection-form_input-data" />
                                    <input class="btn btn-browse form-control" type="button" value="Browse..." onclick="document.getElementById('selection-form_input-data').click();" id="selection-form_upload-btn">
                                    <input class="pull-right btn" type="button" onclick="removeFile()" value="&times; remove file"></input></input>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="exampleselect">
                                        Select an example dataset
                                    </label>
                                    <select class="form-control" name="example" id="exampleselect">
                                        <option value="null">Select a dataset</option>
                                        <!-- <option value="zhang_example.csv">Zhang, 2000</option> -->
                                        <option value="calce-example.csv">CALCE (Ctr. for Adv. Life Cycle Eng.)</option>
                                        <option value="wu_example.csv">Wu</option>
                                        <option value="samsung_example.csv">Samsung NMC</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="dropdown form-group" id="dropdown-analysis">
                                    <label for="dropdown-btn">
                                        Select analysis to perform
                                    </label>
                                    <button class="btn btn-info form-control" id="dropdown-btn" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Analysis
                                        <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdown-btn" style="padding: 10px">
                                        <li>
                                            <div class="form-group">
                                                <label>Equivalent circuits</label>
                                                <div class="checkbox">
                                                    <label>
                                                        <input type="checkbox" id="checkbox-randles" name="EC-randles" value=""/>Randles' circuit
                                                    </label>
                                                </div>
                                                <div class="checkbox">
                                                    <label style="">
                                                        <input type="checkbox" name="EC-two_constant_warburg" value="" id="checkbox-twoConstantWarburg"/>Two time constant w/ Warburg
                                                    </label>
                                                </div>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="form-group">
                                                <label>Physics-based models</label>
                                                <div class="checkbox">
                                                    <label>
                                                        <input type="checkbox" id="checkbox-P2D" name="pb-p2d" value=""/>P2D battery model
                                                    </label>
                                                </div>
                                                <div class="checkbox disabled">
                                                    <label class=disabled>
                                                        <input disabled="disabled" type="checkbox" id="checkbox-add" name="" value=""/>Your model?
                                                    </label>
                                                </div>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="form-group">
                                                <label>Validation</label>
                                                <div class="checkbox disabled">
                                                    <label class="disabled">
                                                        <input disabled="disabled" type="checkbox" id="checkbox-add" name="" value=""/>Kramer-Kronig
                                                    </label>
                                                </div>
                                                <div class="checkbox disabled">
                                                    <label class="disabled">
                                                        <input disabled="disabled" type="checkbox" id="checkbox-add" name="" value=""/>Measurement Model
                                                    </label>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="dropdown form-group">
                                    <label for="plot_btn">
                                    </label>
                                    <input class="btn btn-plot pull-right form-control" disabled="disabled" type="" onclick="submitAnalysis()" value="Go" id="plot_btn" >
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="row" id="second-row">
                <div class="col-md-8" id="grid-impedance">
                    <div class="row" style="height: 100%">
                        <div id="loadingDiv" class="spinner"></div>
                        <div class="col-md-6" style="height: 100%">
                                <div id="bode" style="height: 100%"></div>
                        </div>
                        <div class="col-md-6" style="height: 100%">
                            <div id="nyquist" style="height: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4" id="grid-parameters">
                    <h4>  Parameter Estimates<i class="glyphicon glyphicon-question-sign" id="info-parameters" data-toggle="tooltip" title="Additional information" aria-hidden="true"></i></h3>
                    <ul class="nav nav-tabs" role="tablist">
                        <!-- filled in after ajax request -->
                    </ul>
                    <div class="tab-content">
                        <!-- filled in dynamically -->
                    </div>
                </div>
            </div>

        </div>

        <nav class="navbar navbar-default navbar-fixed-bottom">
            <div class="container.fluid">
                <img class="" src="{{ url_for('static', filename='images/W.png') }}" alt="CEI logo" style="height: 30px; margin: 5px 10px;">
                <img class="pull-right" src="{{ url_for('static', filename='images/CEI_logo_tag_color.png') }}" alt="CEI logo" style="height: 30px; margin: 5px 10px;">
                <img class="pull-right" src="{{ url_for('static', filename='images/IGERT.png') }}" alt="CEI logo" style="height: 30px; margin: 5px 10px;">
            </div>
        </nav>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

        <script type="text/javascript">
        $('#loadingDiv').hide();
        $(document).ajaxStart(function() {
            $("#loadingDiv").show();
        });

        $(document).ajaxStop(function() {
            $("#loadingDiv").hide();
        });
        </script>

        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

        <!-- d3 -->
        <script src="https://d3js.org/d3.v3.min.js"></script>

        <script type=text/javascript>
            $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
        </script>

        <!-- Functions for loading impedance data and selecting options/inputs -->
        <script type="text/javascript">
            $('.dropdown-toggle').dropdown()
            $('.dropdown-menu').click(function(e) {
                e.stopPropagation();
            });
            $('#dropdown-analysis').on('hidden.bs.dropdown', function() {
                var selected = $('input[type="checkbox"]:checked');
                // var names = "Plot";
                // selected.each(function(i,d){
                //     names += d.name;
                // }
                // )
                // if (names != "") {
                //     $('#dropdown-btn').text(names);
                // } else {
                //     $('#dropdown-btn').text("Select")
                // }

                optionsModal(selected);
            });

            function optionsModal(selected) {
                $("#modal-analysis div.modal-body ul").empty();
                $("#modal-analysis div.modal-body #ECtab").empty();
                loadModal(selected);
            }

            function loadModal(selected) {
                var circuits =
                    {"randles":
                        {"name": "Randles Circuit",
                        "id": "randles",
                        "type": "ec",
                        "image": "randles.png",
                        "parameters": ["R0", "R1", "C1", "W1", "W2"],
                        "values": ["0.01", "0.005", ".1", ".0001", ".001"],
                        "units": ["Ohms", "Ohms", "F", "Ohms", "Sec"],
                        "circuit": "R0-p(R1,C1)-W1/W2"
                    },
                    "two_constant_warburg" :
                        {"name": "Two Time Constant Circuit",
                        "id": "two_constant_warburg",
                        "type": "ec",
                        "image": "two_time_constants.png",
                        "parameters": ["R0", "R1", "C1", "R2", "C2", "W1", "W2"],
                        "values": ["0.01", "0.005", ".1", "0.005", ".1", ".0001", ".001"],
                        "units": ["Ohms", "Ohms", "F", "Ohms", "F", "Ohms", "Sec"],
                        "circuit": "R0-p(R1,C1)-p(R2,C2)-W1/W2"
                    }
                };

                var physics =
                    {"p2d":
                        {"id": "p2d",
                        "name": "P2D",
                        "type": "pb",
                        "image": "p2d.png"
                        }
                    };

                if (selected.length > 0) {

                    selected.each(function(i,d) {
                        if (d.name.startsWith('EC')) {
                            name = d.name.split('-')[1]
                            circuit = circuits[name]
                            // append tab
                            $("#modal-analysis div.modal-body ul").append(
                                "<li class='nav' role='presentation'>" +
                                    "<a role='tab' data-toggle='tab' href='#" + circuit.id + "'>" +
                                        "<img src='impedance-application/static/images/" + circuit.image + "' alt='' />" +
                                    "</a>" +
                                "</li>"
                            );

                            // create form groups for ECtabs
                            groups = ""

                            circuit.parameters.forEach(function(p, i) {
                                groups = groups +
                                    "<div class='form-group'>" +
                                        "<label for='" + p + "' class='col-sm-2 control-label'>" + p + "</label>" +
                                        "<div class='col-sm-8 input-group'>" +
                                            "<input type='text' name='" + p + "' value='" + circuit.values[i] + "' class='form-control'>" +
                                            "<div class='input-group-addon'>" + circuit.units[i] + "</div>" +
                                        "</div>" +
                                    "</div>"
                            });

                            // append tab-content
                            $("#modal-analysis div.modal-body #ECtab").append(
                                "<div class='tab-pane' id='" + circuit.id +
                                                "' name= '" + circuit.name +
                                                "' circuit='" + circuit.circuit  +
                                                "' units='"+ circuit.units +
                                                "' model-type='" + circuit.type + "'>" +
                                    "<h5>Initial Guesses</h5>" +
                                    "<form class='form-horizontal' id='defineECparam'>" +
                                        groups +
                                        "<div class='form-group'>" +
                                            "<button type='button' class='btn btn-primary btn-next pull-right'>Next</button>" +
                                        "</div>" +
                                    "</form>" +
                                "</div>"
                            );
                        }

                        if (d.name.startsWith('pb')) {
                            name = d.name.split('-')[1]
                            model = physics[name]

                            // append tab
                            $("#modal-analysis div.modal-body ul").append(
                                "<li class='nav' role='presentation'>" +
                                    "<a role='tab' data-toggle='tab' href='#" + model.id + "'>" +
                                        "<img src='impedance-application/static/images/" + model.image + "' alt='' />" +
                                    "</a>" +
                                "</li>"
                            );

                            // create form groups for ECtabs
                            groups = "<h5>Currently, fitting the P2D model requires no user-defined parameters.</h5>"
                            groups += "<br></br><h5>Model runs: <emph>25,161</emph></h5>"

                            // append tab-content
                            $("#modal-analysis div.modal-body #ECtab").append(
                                "<div class='tab-pane' id='" + model.id +
                                                    "' name= '" + model.name +
                                                    "' model-type='" + model.type + "'>" +
                                    "<form class='form-horizontal' id='defineECparam'>" +
                                        groups +
                                        "<div class='form-group'>" +
                                            "<button type='button' class='btn btn-primary btn-next pull-right'>Next</button>" +
                                        "</div>" +
                                    "</form>" +
                                "</div>"
                            );
                        }

                    });

                    $("#modal-analysis div.modal-body .tab-pane:last .btn-next")
                        .removeClass('btn-next')
                        .addClass('btn-save')
                        .attr('data-dismiss', 'modal')
                        .text('Finished');

                    $('.btn-next').click(function(){
                        $('.nav-tabs > .active').next('li').find('a').trigger('click');
                    });

                    $("#modal-analysis div.modal-body ul li:first").addClass('active')
                    $("#modal-analysis div.modal-body #ECtab div.tab-pane:first").addClass('active')

                    $('#modal-analysis').modal('show')
                }
            }

            function submitAnalysis() {

                $('#grid-impedance div#bode').empty()
                $('#grid-impedance div#nyquist').empty()
                $('#grid-parameters ul').empty()
                $("#grid-parameters div.tab-content").empty()
                $('#explore-residuals').empty()
                $('#explore-nyquist').empty()

                var exampleSelected = $('#exampleselect option:selected')[0].value != "null"

                var uploadSelected = $('#selection-form_input-data')[0].files.length > 0;

                if(uploadSelected) {
                    var formData = new FormData()
                    var fileData = $('#selection-form_input-data')[0].files[0]
                    formData.append('data', fileData);
                    $.ajax({
                        url: $SCRIPT_ROOT + '/getUploadData',
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false,
                        async: false,
                        cache: false,
                        success: function(response) {
                            initializeCharts(response.data);
                            plotModels(response.data);
                        },
                        error: function(error) {
                            console.log(error);
                        }
                    });
                } else if(exampleSelected){
                    var filename = $('#exampleselect option:selected')[0].value;
                    $.getJSON($SCRIPT_ROOT + '/getExampleData', {
                            data_type: "example",
                            filename: filename
                        },function(response) {
                            initializeCharts(response.data);
                            plotModels(response.data);
                        }
                    );
                };

                function plotModels(data) {

                    var models = $('#modal-analysis div.modal-body #ECtab .tab-pane').toArray()

                    while(models.length > 0) {
                        model = models.shift();
                        makeRequest(model, data);
                    }
                };

                function makeRequest(model, data) {
                    var formData = new FormData();

                    var id = model.getAttribute('id')
                    var name = model.getAttribute('name')
                    var modelType = model.getAttribute('model-type')

                    var example = 'true'
                    var filename = $('#exampleselect option:selected')[0].value

                    if (modelType == "ec") {

                        var circuit = model.getAttribute('circuit')
                        var units = model.getAttribute('units')

                        var inputs = $('#modal-analysis div.modal-body #ECtab .tab-pane#' + id + " :input:not(:button)")

                        // p0 = {}
                        var p0 = []

                        inputs.each(function(i,p) {
                            // p0[p.name] = p.value;
                            p0[i] = p.value;
                        })

                        formData.append('p0', p0.toString())
                        formData.append('data', data)

                        formData.append('filename', filename)
                        formData.append('circuit', circuit)

                        $.ajax({
                            url: $SCRIPT_ROOT + '/fitCircuit',
                            type: "POST",
                            data: formData,
                            processData: false,
                            contentType: false,
                            async: false,
                            cache: false,
                            success: function(response) {
                                addData(response.ecFit, id, name, data);
                                createParameterTab(id, name, response.names, units.split(','), response.values, response.errors);
                            },
                            error: function(error) {
                                console.log(error);
                            }
                        });
                    } else if (modelType == "pb") {

                        formData.append('data', data)
                        formData.append('filename', filename)

                        $.ajax({
                            url: $SCRIPT_ROOT + '/fitPhysics',
                            type: "POST",
                            data: formData,
                            async: false,
                            processData: false,
                            contentType: false,
                            cache: false,
                            success: function(response) {
                                addData(response.pbFit, id, name, data);
                                createParameterTab(id, name, response.names, response.units, response.values, response.errors);
                                populateModule(response.results, response.simulations, response.names, data);
                                addP2dexploreButton();
                            },
                            error: function(error) {
                                console.log(error);
                            }
                        });
                    }
                }
            }

            function uncheckEC() {
                /* Unchecks the equivalent circuit selection box if modal is closed */
                $('#ecinput').prop('checked', false);
            }

            function ecdefine() {
                /* Opens the equivalent circuit modal when the checkbox is checked */
                if($('#ecinput').is(':checked')) {
                    document.getElementById('btn_ecmodal').click();
                }
            }

            /* ensure plot button is disabled until file is selected */
            $('#selection-form_input-data').on('change', function() {
                $('#selection-form_upload-btn').val($(this).val());
                $('#plot_btn').prop('disabled', false);
                $('#modelFieldset').removeProp('disabled');
            });
            $('#exampleselect').on('change', function() {
                $('#plot_btn').prop('disabled', false);
                $('#modelFieldset').removeProp('disabled');
            });

            function removeFile() {
                $('#selection-form_input-data')[0].value = "";
                $('#selection-form_upload-btn')[0].value = "Browse...";
                var exampleSelected = $('#exampleselect option:selected')[0].value != "null"
                if(!exampleSelected) {
                    $('#plot_btn').prop('disabled', true);
                }
            }
        </script>

        <!-- bootstrap tooltips -->
        <!-- TODO: Add tooltip help here -->
        <script type="text/javascript">
        $('#info-fileupload').prop('title', 'TODO: The uploaded .csv file will be interpreted with the first column as frequency, second column as real impedance, third column as imaginary impedance.')
        $('#info-parameters').prop('title', 'Error indicates estimated standard deviation of fit parameters');
        </script>

        <script type="text/javascript">
        $(function () {
            $('[data-toggle="tooltip"]').tooltip({ placement: 'bottom'})
        })
        </script>

        <!-- add svg button -->
        <script type="text/javascript" src="{{ url_for('static', filename='button.js') }}"> </script>

        <!-- draw Nyquist with d3 -->
        <script type="text/javascript" src="{{ url_for('static', filename='nyquist-models.js') }}"> </script>

        <script type="text/javascript">
            function addP2dexploreButton() {
                var svg = d3.select("#nyquist svg")

                outerWidth = d3.select('#bode').node().getBoundingClientRect().width;
                outerHeight = d3.select('#bode').node().getBoundingClientRect().height;

                var g = svg.append('g')
                    .attr('class', 'button')
                    .attr('transform', 'translate(' + outerWidth*.75 + ',' + outerHeight*.1 + ')')

                var text = g.append('text')
                    .text('Explore P2D Fit')

                button()
                    .container(g)
                    .text(text)
                    .count(0)
                    .cb(function() { $('#exploreFitModal').modal('show') })();
            }
        </script>

        <script type="text/javascript">
            function createParameterTab(id, name, parameters, units, values, errors) {

                $("#grid-parameters ul").append(
                    "<li class='nav' role='presentation'>" +
                        "<a role='tab' data-toggle='tab' href='#" + "parameters-" + id + "'>" + name +
                        "</a>" +
                    "</li>"
                );

                var rows = ""

                if(id=='p2d') {
                    parameters.forEach(function(p, i) {
                        rows = rows +
                        "<tr>" +
                        "<td>" + p.split('[')[0] + "</td>" +
                        "<td>" + units[i] + "</td>" +
                        "<td>" + values[i].toPrecision(4) + "</td>" +
                        "</tr>"
                    });
                } else {
                    parameters.forEach(function(p, i) {
                        rows = rows +
                        "<tr>" +
                        "<td>" + p.split('[')[0] + "</td>" +
                        "<td>" + units[i] + "</td>" +
                        "<td>" + values[i].toPrecision(4) + "</td>" +
                        "<td>" + errors[i].toPrecision(4) + "</td>" +
                        "<td>" + (100*errors[i]/values[i]).toPrecision(4)  + "</td>"
                        "</tr>"
                    });
                }

                // append tab-content
                    if(id=='p2d') {
                        $("#grid-parameters div.tab-content").append(
                            "<div class='tab-pane' id='" + "parameters-" + id + "'>" +
                                "<div class='table-responsive' id='table-div'>"+
                                    "<table class='table table-condensed' id='parameter-estimates'>" +
                                        "<tr>" +
                                            "<th>Parameter</th>" +
                                            "<th>Units</th>" +
                                            "<th>Best Estimate</th>" +
                                        "</tr>" +
                                        rows +
                                    "</table>" +
                                "</div>" +
                            "</div>"
                        );
                    } else {
                        $("#grid-parameters div.tab-content").append(
                            "<div class='tab-pane' id='" + "parameters-" + id + "'>" +
                                "<div class='table-responsive' id='table-div'>"+
                                    "<table class='table table-condensed' id='parameter-estimates'>" +
                                        "<tr>" +
                                            "<th>Parameter</th>" +
                                            "<th>Units</th>" +
                                            "<th>Best Estimate</th>" +
                                            "<th data-toggle='tooltip' title='The error is given as the estimated one-sigma standard deviation'>Error</th>" +
                                            "<th>% Error</th>" +
                                        "</tr>" +
                                        rows +
                                    "</table>" +
                                "</div>" +
                            "</div>"
                        );
                    }

                $("#grid-parameters ul li:first").addClass('active')
                $("#grid-parameters div.tab-content div.tab-pane:first").addClass('active')

            }
        </script>
        <script type="text/javascript">

        function phase(real, imag) {
            return Math.atan2(imag,real)*180/Math.PI;
        }

        function mag(real, imag) {
            return Math.sqrt(Math.pow(imag, 2) + Math.pow(real, 2));
        }

        function initializeCharts(data) {
            outerWidth = d3.select('#bode').node().getBoundingClientRect().width;
            outerHeight = d3.select('#bode').node().getBoundingClientRect().height;

            var margin = {top: outerHeight*.01, right: outerWidth*.01, bottom: outerHeight*.12, left: outerWidth*.12};
            var width = outerWidth - margin.left - margin.right;
            var height = outerHeight/2 - margin.top - margin.bottom;

            var xScale_ph = d3.scale.log();
            var yScale_ph = d3.scale.linear();

            var xScale_mag = d3.scale.log();
            var yScale_mag = d3.scale.log();

            var xAxis_ph = d3.svg.axis()
                .scale(xScale_ph)
                .ticks(5)
                .orient('bottom');

            var yAxis_ph = d3.svg.axis()
                .scale(yScale_ph)
                .ticks(5)
                .orient('left');

            var xAxis_mag = d3.svg.axis()
                .scale(xScale_mag)
                .ticks(5)
                .orient('bottom');

            var yAxis_mag = d3.svg.axis()
                .scale(yScale_mag)
                .ticks(5)
                .orient('left');

            xScale_ph
                .range([0, width])
                .domain(d3.extent(data, function(d, i) { return d[0]} ));

            yScale_ph
                .range([height, 0])
                .domain([0, 1.1*d3.min(data, function(d, i) { return phase(d[1], d[2])} )]);

            xScale_mag
                .range([0, width])
                .domain(d3.extent(data, function(d, i) { return d[0]} ));

            yScale_mag
                .range([height, 0])
                .domain(d3.extent(data, function(d, i) { return mag(d[1], d[2])} ))
                .nice();

            // Select the svg element, if it exists.
            var svg_ph = d3.select('#bode').append("svg").attr("id", "phase")
            var svg_mag = d3.select('#bode').append("svg").attr("id", "magnitude")


            var plot_ph = svg_ph.append("g");
            var plot_mag = svg_mag.append("g");

            plot_ph.append("g").attr("class", "x axis");
            plot_ph.append("g").attr("class", "y axis");

            plot_mag.append("g").attr("class", "x axis");
            plot_mag.append("g").attr("class", "y axis");

            // Update the outer dimensions.
            svg_ph
                .attr("width", outerWidth)
                .attr("height", outerHeight/2);

            svg_mag
                .attr("width", outerWidth)
                .attr("height", outerHeight/2);

            var g_ph = svg_ph.select("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var g_mag = svg_mag.select("g")
                .attr("transform", "translate(" + margin.left + "," + (margin.top) +  ")");

            var tooltip_ph = g_ph.append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            var tooltip_mag = g_mag.append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            g_ph.select(".x.axis")
                .attr('transform', 'translate(0,' + height + ')')
                .call(xAxis_ph)

            g_ph.select(".y.axis")
                .attr('transform', 'translate(0,' + 0 + ')')
                .call(yAxis_ph)

            g_mag.select(".x.axis")
                .attr('transform', 'translate(0,' + height + ')')
                .call(xAxis_mag)

            g_mag.select(".y.axis")
                .attr('transform', 'translate(0,' + 0 + ')')
                .call(yAxis_mag)

            g_ph.append("text")
                .attr("class", "label")
                .attr("transform", "translate(" + (width/2) + " ," +
                                                (height + margin.bottom - 10) + ")")
                .style("text-anchor", "middle")
                .text("Frequency [Hz]");

            g_ph.append("text")
                .attr("class", "label")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left - 1)
                .attr("x",0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("-Phase [deg]");

            g_mag.append("text")
                .attr("class", "label")
                .attr("transform", "translate(" + (width/2) + " ," +
                                                (height + margin.bottom - 10) + ")")
                .style("text-anchor", "middle")
                .text("Frequency [Hz]");

            g_mag.append("text")
                .attr("class", "label")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left - 1)
                .attr("x",0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Magnitude [Ohms]");

            var phases = g_ph.selectAll("circle").data(data);

            phases.enter().append('circle');
            phases
                .attr("class", "default-circle")
                .attr("cx", function (d) { return xScale_ph( d[0] ); } )
                .attr("cy", function (d) { return yScale_ph( phase(d[1], d[2]) ); } )
                .attr("r", 5)
                .on("mouseover", function(d,i) {
                    d3.select(this)
                        .classed("selected-circle", true)
                        .attr("r", 10);

                    g_mag.selectAll("circle")
                        .data(data)
                        .classed("selected-circle", function(d2, i2) {return i2 == i; })
                        .attr("r", function(d2, i2) { if(i2 == i) { return 10; } else { return 5;} });

                    d3.select("#nyquist").selectAll("circle")
                        .data(data)
                        .classed("selected-circle", function(d2, i2) {return i2 == i; })
                        .attr("r", function(d2, i2) { if(i2 == i) { return 10; } else { return 5;} });

                    tooltip_ph.transition()
                        .duration(200)
                        .style("opacity", .9);

                    tooltip_ph.html('Freq: ' + Math.round(d[0]*1000)/1000 + "<br/>"  +
                                        'Phase: ' + Math.round(phase(d[1], d[2])*1000)/1000)
                                        .style("left", 30 + "px")
                                        .style("top", 30 + "px");

                })
                .on("mouseout", function(d,i) {
                    d3.select(this)
                        .attr("class", "default-circle")
                        .attr("r", 5);

                    g_mag.selectAll("circle")
                        .data(data)
                        .attr("class", "default-circle")
                        .attr("r", 5);

                    d3.select("#nyquist").selectAll("circle")
                        .data(data)
                        .attr("class", "default-circle")
                        .attr("r", 5);
                });

            var mags = g_mag.selectAll("circle").data(data);

            mags.enter().append('circle');
            mags
                .attr("class", "default-circle")
                .attr("cx", function (d) { return xScale_mag( d[0] ); } )
                .attr("cy", function (d) { return yScale_mag( mag(d[1], d[2]) );  } )
                .attr("r", 5)
                .on("mouseover", function(d,i) {
                    d3.select(this)
                        .classed("selected-circle", true)
                        .attr("r", 10);

                    // console.log(phases);
                    g_ph.selectAll("circle")
                        .data(data)
                        .classed("selected-circle", function(d2, i2) {return i2 == i; })
                        .attr("r", function(d2, i2) { if(i2 == i) { return 10; } else { return 5;} });

                    d3.select("#nyquist").selectAll("circle")
                        .data(data)
                        .classed("selected-circle", function(d2, i2) {return i2 == i; })
                        .attr("r", function(d2, i2) { if(i2 == i) { return 10; } else { return 5;} });

                    // tooltip.transition()
                    //     .duration(200)
                    //     .style("opacity", .9);
                    //
                    // tooltip.html('Freq: ' + Math.round(d[0]*1000)/1000 + "<br/>"  +
                    //                     'Mag: ' + Math.round(mag(d[1], d[2])*1000)/1000)
                    //                     .style("left", (outerWidth - 30) + "px")
                    //                     .style("top", outerHeight*3/4 + "px");

                })
                .on("mouseout", function(d,i) {
                    d3.select(this)
                        .attr("class", "default-circle")
                        .attr("r", 5);

                    g_ph.selectAll("circle")
                        .data(data)
                        .attr("class", "default-circle")
                        .attr("r", 5);

                    d3.select("#nyquist").selectAll("circle")
                        .data(data)
                        .attr("class", "default-circle")
                        .attr("r", 5);

                });

                var nyquist = nyquistChart({width: outerWidth, height: outerHeight, ec: "", p2d: "", ecid: ""})
                    .x(function(d) { return d[1] })
                    .y(function(d) { return -d[2] });

                d3.select("#nyquist")
                    .datum(data)
                    .call(nyquist);

        }
            function addData(ec, id, name, data) {

                outerWidth = d3.select('#bode').node().getBoundingClientRect().width;
                outerHeight = d3.select('#bode').node().getBoundingClientRect().height;

                var margin = {top: outerHeight*.01, right: outerWidth*.01, bottom: outerHeight*.12, left: outerWidth*.12};
                var width = outerWidth - margin.left - margin.right;
                var height = outerHeight/2 - margin.top - margin.bottom;

                var xScale_ph = d3.scale.log();
                var yScale_ph = d3.scale.linear();

                var xScale_mag = d3.scale.log();
                var yScale_mag = d3.scale.log();

                xScale_ph
                    .range([0, width])
                    .domain(d3.extent(data, function(d, i) { return d[0]} ));

                yScale_ph
                    .range([height, 0])
                    .domain([0, d3.min(data, function(d, i) { return phase(d[1], d[2])} )]);

                xScale_mag
                    .range([0, width])
                    .domain(d3.extent(data, function(d, i) { return d[0]} ));

                yScale_mag
                    .range([height, 0])
                    .domain(d3.extent(data, function(d, i) { return mag(d[1], d[2])} ))
                    .nice();

                g_ph = d3.select('#bode svg#phase g')

                var line_phase = d3.svg.line()
                    .x(function(d) { return xScale_ph( d[0] ); })
                    .y(function(d) { return yScale_ph( phase(d[1], d[2]) ); });

                    g_ph.append("path")
                      .datum(ec)
                      .attr("class", id + "-fit")
                      .attr("name", name)
                      .attr("d", line_phase);

                g_mag = d3.select('#bode svg#magnitude g')

                var line_mag = d3.svg.line()
                    .x(function(d) { return xScale_mag( d[0] ); })
                    .y(function(d) { return yScale_mag( mag(d[1], d[2]) ); });

                g_mag.append("path")
                    .datum(ec)
                    .attr("class", id + "-fit")
                    .attr("d", line_mag);

              var nyquist = nyquistChart({width: outerWidth, height: outerHeight, ec: ec, p2d: "", ecid: id})
                  .x(function(d) { return d[1] })
                  .y(function(d) { return -d[2] });

              d3.select("#nyquist")
                  .datum(data)
                  .call(nyquist);

            // add legend

            var paths = []

            $('#bode svg#phase path').not('.domain').each(function(i,d) {
                paths[i] = {name: d.getAttribute('name'),
                            id: d.getAttribute('class').split('-')[0]}
            });

            var legend = d3.select("#nyquist svg").selectAll("circle#legend")
                            .data(paths);


            legend.enter().append('text');

            legend
                .attr("id", "legend")
                .attr('r', 5)
                .attr('x', margin.left + 40)
                .attr('y', function(d,i) {return 40 + 20*(i+1) + "px";})
                .attr('class', function(d) {return d.id + '-legend';})
                .text(function(d) {return d.name;});

            }
        </script>

        <script type="text/javascript">
            function populateModule(sorted_results, simulations, names, data) {

                outerWidth = $(window).width()*.98/3;
                outerHeight = $(window).height()*.9;

                var size = d3.min([outerWidth,outerHeight]);

                var svg_res = d3.select('#explore-residuals').append("svg")
                var svg_nyq = d3.select('#explore-nyquist').append("svg")

                var margin = {top: 10, right: 10, bottom: 60, left: 60};
                var width = size - margin.left - margin.right;
                var height = size - margin.top - margin.bottom;

                var xScale_res = d3.scale.linear()
                var yScale_res = d3.scale.linear()

                var xScale_nyq = d3.scale.linear()
                var yScale_nyq = d3.scale.linear()

                var xAxis_res = d3.svg.axis()
                    .scale(xScale_res)
                    .ticks(5)
                    .orient('bottom');

                var yAxis_res = d3.svg.axis()
                    .scale(yScale_res)
                    .ticks(5)
                    .orient('left');

                xScale_res
                    .range([0, width])
                    .domain(d3.extent(sorted_results, function(d, i) { return i} ));

                yScale_res
                    .range([height, 0])
                    .domain(d3.extent(sorted_results, function(d, i) { return d[2]} ));


                // Update the outer dimensions.
                svg_res
                    .attr("width", outerWidth)
                    .attr("height", outerHeight);

                svg_nyq
                    .attr("width", outerWidth)
                    .attr("height", outerHeight);

                var plot_res = svg_res.append("g");
                var plot_nyq = svg_nyq.append("g");

                plot_res.append("g")
                    .attr("class", "x axis")
                    .attr("width", width)
                    .attr("height", height);

                plot_res.append("g")
                    .attr("class", "y axis")
                    .attr("width", width)
                    .attr("height", height);

                var g_res = svg_res.select("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var g_nyq = svg_nyq.select("g")
                    .attr("transform", "translate(" + margin.left + "," + (margin.top) +  ")");

                // var tooltip_ph = g_ph.append("div")
                //     .attr("class", "tooltip")
                //     .style("opacity", 0);
                //
                // var tooltip_mag = g_mag.append("div")
                //     .attr("class", "tooltip")
                //     .style("opacity", 0);

                g_res.select(".x.axis")
                    .attr('transform', 'translate(0,' + height + margin.bottom + ')')
                    .call(xAxis_res)

                g_res.select(".y.axis")
                    .attr('transform', 'translate(0,' + 0 + ')')
                    .call(yAxis_res)


                g_res.append("text")
                    .attr("class", "label")
                    .attr("transform", "translate(" + (width/2) + " ," +
                                                    (height + margin.bottom - 10) + ")")
                    .style("text-anchor", "middle")
                    .text("Number #");

                g_res.append("text")
                    .attr("class", "label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left - 0)
                    .attr("x",0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("Avg. % Error");

                var div = d3.select("#explore-residuals").append("div")
                    .attr("class", "explore-tooltip")
                    .style("opacity", 0);

                var residuals = g_res.selectAll("circle").data(sorted_results);

                var last_p = names

                residuals.enter().append('circle');
                residuals
                    .attr("class", "default-circle")
                    .attr("cx", function (d, i) { return xScale_res(i); } )
                    .attr("cy", function (d) { return yScale_res(d[2]); } )
                    .attr("r", 5)
                    .on("mouseover", function(d, i) {
                        impedance = simulations.find( function(data) { return data[0] == d[0]; });
                        scale = d[1];
                        parameters = get_parameters(impedance)

                        plot_impedance(impedance, scale)

                        d3.select(this).style("fill", "red")

                        div.transition()
                            .duration(200)
                            .style("opacity", 1);

                        div.html(
                            'Rank: ' + (i+1) + '<br>' +
                            'MSE:  ' + Math.round(d[2] * 1000)/ 1000  + '%'  + '<br>' +
                            'Run: '+ d[0])
                            .style("left", 0.8*width + "px")
                            .style("top", 0.8*height + "px");

                        d3.select("#parameter-estimates tbody").selectAll(".dataRow")
                            .data(parameters)
                            .enter()
                            .append("tr")
                            .attr("class", "dataRow")


                        d3.select("#parameter-estimates tbody").selectAll(".dataRow")
                            .data(parameters)
                            .attr("class", "dataRow")
                            .classed("info", function(d, i) {
                                return last_p[i].value != parameters[i].value;
                            })

                        d3.selectAll("#parameter-estimates tbody .dataRow")
                           .selectAll("td")
                           .data([0,1,2])
                           .enter()
                           .append("td")

                       d3.selectAll("#parameter-estimates tbody .dataRow")
                          .selectAll("td")
                          .data(
                              function(row) {
                              return ["name", "units", "value"].map(function(d) {
                                  return {value: row[d]};
                              });
                          })
                          .html(function(d) { return d.value; });

                          last_p = parameters

                        })
                        .on("mouseout", function(d) {
                            d3.select(this).transition().duration(150).style("fill", "#009688");
                        });

                initialize_impedance(data);

                function get_parameters(data) {
                    parameters = []

                    names.forEach(function(d,i) {
                        parameters[i] = {
                            name: d.split("[")[0],
                            units: d.split("[")[d.split("[").length-1].replace("]", ""),
                            value: impedance[4].split(',')[i]
                        }
                    })
                    return parameters
                }

                function plot_impedance(data, scale) {
                    impedance = [];

                    data[1].split(',').forEach(function(d,i) {
                        impedance[i] = {
                            f: +d,
                            real: +data[2].split(',')[i],
                            imag: -1*(+data[3].split(',')[i])
                        }
                    })

                    impedances = g_nyq.selectAll(".circles").data(impedance)

                    // define the line
                    var line = d3.svg.line()
                        .x(function(d) { return xScale_nyq(d.real/scale); })
                        .y(function(d) { return yScale_nyq(d.imag/scale); });

                    g_nyq.selectAll("path")
                      .datum(impedance)
                      .attr("class", "p2d-fit")
                      .transition().duration(100)
                      .attr("d", line);

                    impedances
                            .enter().append("circle")
                            .attr("class", "circles")
                            .attr("r", 5)

                    impedances
                            .transition().duration(100)
                            .attr("cx", function(d) {return xScale_nyq(d.real/scale)})
                            .attr("cy", function(d) { return yScale_nyq(d.imag/scale)})

                    impedances
                        .exit().remove();

                    };

                    function initialize_impedance(data) {

                        plot_nyq.append("g").attr("class", "x axis");
                        plot_nyq.append("g").attr("class", "y axis");

                        max = d3.max( [d3.max(data, function(d, i) { return d[1]} ) - d3.min(data, function(d, i) { return d[1]} ),
                                                d3.max(data, function(d, i) { return -d[2]} ) - d3.min(data, function(d, i) { return -d[2]} )]);

                        xScale_nyq
                            .range([0, width])
                            .domain([ d3.min(data, function(d, i) { return d[1]} ) - max*.1,  d3.min(data, function(d, i) { return d[1]} ) + max*1.4]);

                        yScale_nyq
                            .range([height, 0])
                            .domain([0, max*1.5]);

                        var xAxis_nyq = d3.svg.axis()
                            .scale(xScale_nyq)
                            .ticks(5)
                            .orient('bottom');

                        var yAxis_nyq = d3.svg.axis()
                            .scale(yScale_nyq)
                            .ticks(5)
                            .orient('left');

                        g_nyq.select(".x.axis")
                            .attr('transform', 'translate(0,' + height + ')')
                            .call(xAxis_nyq)

                        g_nyq.select(".y.axis")
                            .attr('transform', 'translate(0,' + 0 + ')')
                            .call(yAxis_nyq)

                        g_nyq.append("text")
                            .attr("class", "label")
                            .attr("transform", "translate(" + (width/2) + " ," +
                                                            (height + margin.bottom - 10) + ")")
                            .style("text-anchor", "middle")
                            .text("Z' [Ohms]");

                        g_nyq.append("text")
                            .attr("class", "label")
                            .attr("transform", "rotate(-90)")
                            .attr("y", -margin.left - 1)
                            .attr("x",0 - (height / 2))
                            .attr("dy", "1em")
                            .style("text-anchor", "middle")
                            .text("-Z'' [Ohms]");

                        var nyquist = g_nyq.selectAll("circle").data(data);

                        nyquist.enter().append('circle');
                        nyquist
                            .attr("class", "default-circle")
                            .attr("cx", function (d, i) { return xScale_nyq(d[1]); } )
                            .attr("cy", function (d) { return yScale_nyq(-d[2]); } )
                            .attr("r", 5)

                    }

            }
        </script>

    </body>
</html>
