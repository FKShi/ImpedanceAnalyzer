<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Impedance Analyzer</title>


        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

        <link rel="stylesheet" href="{{ url_for('static', filename='nyquist.css') }}">

        <style media="screen">

        /************** Customize NavBar ******************/
        .navbar-custom {
            margin-bottom: 0px;
            background-color: #009688;
            color:#009688;
        }

        /*  Link colors     */
        .navbar-custom .navbar-nav > li > a {
          	color:#fff;
            font-weight: bold;
        }

        .navbar-custom .navbar-nav > .active > a, .navbar-nav > .active > a:hover, .navbar-nav > .active > a:focus {
            color: #fff;
        	background-color:transparent;
        }

        /* Hover background */
        .navbar-custom .navbar-nav > li > a:hover, .nav > li > a:focus {
            text-decoration: none;
            background-color: #B2DFDB;
            color: #FF5722;
            font-weight: bold;
        }

        .navbar-custom .navbar-brand {
          	color:#fff;
            font-weight: bold;
        }
        .navbar-custom .navbar-toggle {
          	background-color:#eeeeee;
        }
        .navbar-custom .icon-bar {
          	background-color:#009688;
        }

        /*@media (min-width:768px){
            .navbar-custom .navbar-nav > li:last-child {
                border-left:2px solid #fff;
            }
        }*/
        /************* End Customize NavBar **************/

        html, body {
            height:100%;
        }

        /* Medium devices (desktops, 992px and up) */
        @media screen and (min-device-width: 992px) {
            #first-row {
                height: 30%;
            }

            #second-row {
                height: 70%;
            }
        }

        div #grid-impedance, #grid-parameters,
        #grid-introduction, #grid-load {
            height: 100%;
            background-color: #FFFFFF;
            border: 2px #BDBDBD solid;
            padding: 0px 10px;
            overflow-y: auto;
            }

        .glyphicon-question-sign {
            font-size: .5em;
            vertical-align: top;
        }

        .btn-browse {
            background-color: #80cbc4;
        }

        .btn-plot {

            transition: all 0.3s ease 0s;
            background-color: #FF5722;
            font-weight: bold;
            color: #FFFFFF;
        }

        .btn-plot:hover:enabled {
            transition: all 0.3s ease 0s;
            background-color: #FF5722;
            font-weight: bold;
            color: #FFFFFF;
            -webkit-transform: scale(1.2);
            -ms-transform: scale(1.2);
            transform: scale(1.2);
        }

        .ec-fit {
          fill: none;
          stroke: #FF5722;
          stroke-width: 2px;
        }

        .p2d-fit {
          fill: none;
          stroke: #000;
          stroke-width: 2px;
        }

        .default-circle {
            fill: #009688;
        }

        .selected-circle {
            fill: #FF5722;
        }

        .tooltip {
          position: absolute;
          width: 200px;
          height: 28px;
          pointer-events: none;
        }

        .navbar-fixed-bottom {
            min-height: 40px;
            background-color: #80cbc4;
            /*border-top: 1px solid #BDBDBD;*/
        }

        @media screen and (max-width: 992px) {
            #grid-parameters { padding-bottom: 40px; }
        }

        </style>

    </head>
    <body>

        <!-- Header -->
        <nav class="navbar navbar-static-top navbar-custom">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#">Impedance Analyzer</a>
                </div>
                <div id="navbar" class="collapse navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="#index">Home</a></li>
                        <li><a href="#about">Demo</a></li>
                        <li><a href="#contact">About</a></li>
                    </ul>
                </div><!--/.nav-collapse -->
            </div>
        </nav>

        <!-- Modal for defining Equivalent Circuit-->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Define your equivalent circuit</h4>
                    </div>
                    <div class="modal-body">
                        <input type="radio" class="disabled" value="randles_cpe"><img src="{{ url_for('static', filename='images/randles_cpe.png') }}" alt="" /></input>
                    <form class="form-horizontal" action="" id="defineECparams">
                        <div class="form-group">
                            <label for="R1" class="col-sm-2 control-label">R1</label>
                                <div class="col-sm-8 input-group">
                                    <input type="text" name="R1" value="0.01" class="form-control" style="display:none">
                                    <div class="input-group-addon">Ohms</div>
                                </div>
                        </div>
                        <div class="form-group">
                            <label for="R2" class="col-sm-2 control-label">R2</label>
                                <div class="col-sm-8 input-group">
                                    <input type="text" name="R2" value="0.01" class="form-control" style="display:none">
                                    <div class="input-group-addon">Ohms</div>
                                </div>
                        </div>
                        <div class="form-group">
                            <label for="W1" class="col-sm-2 control-label">W1</label>
                                <div class="col-sm-8 input-group">
                                    <input type="text" name="W1" value=".01" class="form-control" style="display:none">
                                    <div class="input-group-addon">Ohms</div>
                                </div>
                        </div>
                        <div class="form-group">
                            <label for="W2" class="col-sm-2 control-label">W2</label>
                                <div class="col-sm-8 input-group">
                                    <input type="text" name="W2" value="10" class="form-control" style="display:none">
                                    <div class="input-group-addon">Ohms</div>
                                </div>
                        </div>
                        <div class="form-group">
                            <label for="C1" class="col-sm-2 control-label">C1</label>
                                <div class="col-sm-8 input-group">
                                    <input type="text" name="C1" value="0.01" class="form-control" style="display:none">
                                    <div class="input-group-addon">F</div>
                                </div>
                        </div>
                        <div class="form-group">
                            <label for="C2" class="col-sm-2 control-label">C2</label>
                                <div class="col-sm-8 input-group">
                                    <input type="text" name="C2" value="0.8" class="form-control" style="display:none">
                                    <div class="input-group-addon"></div>
                                </div>
                        </div>
                    </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="submitECparams()">Save changes</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid" style="height: calc(100% - 90px);">
            <div class="row" id="first-row">
                <div class="col-md-3" id="grid-introduction">
                    <h4> Welcome to the Impedance Analyzer: </h4><h5>an open-source tool for analyzing EIS data.</h5>
                </div>
                <div class="col-md-9"  id="grid-load">
                    <h4>Upload a file<i id="info-fileupload" class="glyphicon glyphicon-question-sign" data-toggle="tooltip" title="Additional information" aria-hidden="true"></i> or choose an example</h3>
                    <form style="padding: 20px;" class="" method=POST enctype=multipart/form-data action="{{ url_for('index') }}" id="fileinput">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="fileselectbutton"> Select File </label>
                                    <input style="display: none;" type="file" name="data" id="fileselect" />
                                    <input class="btn btn-browse form-control" type="button" value="Browse..." onclick="document.getElementById('fileselect').click();" id="fileselectbutton">
                                    <button class="btn" onclick="reset($('#fileselect'))"><span aria-hidden="true">&times; remove file</span></button></input>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="exampleselect">
                                        Select Example Dataset
                                    </label>
                                    <select class="form-control" name="example" id="exampleselect">
                                        <option value="null">Select a dataset</option>
                                        <!-- <option value="zhang_example.csv">Zhang, 2000</option> -->
                                        <option value="imp-data.csv">EIS data</option>
                                        <option value="wu_example.csv">Wu</option>
                                        <!-- <option>5</option> -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Model(s) to fit: </label>
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" id="ecinput" name="fitting-ec" value="ec" onchange="ecdefine();"/>Equivalent Circuit
                                            <button type="button" id="ecmodal" onclick="submitECparams()" style="display: none;"></button>
                                        </label>
                                    </div>
                                    <div class="checkbox">
                                        <label style="">
                                            <input type="checkbox" name="fitting-p2d" value="p2d"/>Pseudo 2-Dimensional
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <input class="btn btn-plot pull-right" disabled="disabled" type="submit" value="Plot" id="plot" >
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="row" id="second-row">
                <div class="col-md-8" id="grid-impedance">
                    <div class="row">
                        <div class="col-md-6">
                                <div id="bode"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="nyquist"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4" id="grid-parameters">
                    <h4>  Parameter Estimates<i class="glyphicon glyphicon-question-sign" id="info-parameters" data-toggle="tooltip" title="Additional information" aria-hidden="true"></i></h3>
                    <div class="table-responsive" id="table-div">
                        <table class="table" id="parameter-estimates">
                            <tr>
                                <th>
                                    Parameter
                                </th>
                                <th>
                                    Best Estimate
                                </th>
                                <th>
                                    Error
                                </th>
                            </tr>
                            {% for parameter in parameter_results %}
                                <tr>
                                    <td><p>{{ parameter.name }}</p></td>
                                    <td>{{ parameter.value }}</td>
                                    <td>{{ parameter.sensitivity }}</td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <nav class="navbar navbar-default navbar-fixed-bottom">
            <div class="container.fluid">
                <img class="" src="{{ url_for('static', filename='images/W.png') }}" alt="CEI logo" style="height: 30px; margin: 5px 10px;">
                <img class="pull-right" src="{{ url_for('static', filename='images/CEI_logo_tag_color.png') }}" alt="CEI logo" style="height: 30px; margin: 5px 10px;">
                <img class="pull-right" src="{{ url_for('static', filename='images/IGERT.png') }}" alt="CEI logo" style="height: 30px; margin: 5px 10px;">
            </div>
        </nav>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

        <!-- d3 -->
        <script src="https://d3js.org/d3.v3.min.js"></script>

        <!-- submit form -->
        <script type="text/javascript">
        function submitECparams() {
            console.log('Submitting params...');

            // var params = [$("input[name='R1']").val(),
            //                 $("input[name='R2']").val(),
            //                 $("input[name='W1']").val(),
            //                 $("input[name='W2']").val(),
            //                 $("input[name='C1']").val(),
            //                 $("input[name='C2']").val()];

            var inputs = $('#defineECparams :input');
            inputs.each(function() {
                $(this).appendTo('#fileinput');
            });

        }
        </script>

        <!-- file input button -->
        <script type="text/javascript">
        $('#fileselect').on('change', function() {
            $('#fileselectbutton').val($(this).val());
            $('#plot').prop('disabled', false);
            $('#modelFieldset').removeProp('disabled');
        });
        $('#exampleselect').on('change', function() {
            $('#plot').prop('disabled', false);
            $('#modelFieldset').removeProp('disabled');
        });
        window.reset = function (e) {
            e.wrap('<form>').closest('form').get(0).reset();
            e.unwrap();
        }
        </script>

        <!-- bootstrap tooltips -->
        <!-- TODO: Add tooltip help here -->
        <script type="text/javascript">
        $('#info-fileupload').prop('title', 'TODO: The uploaded .csv file will be interpreted with the first column as frequency, second column as real impedance, third column as imaginary impedance.')
        $('#info-parameters').prop('title', 'Error indicates estimated standard deviation of fit parameters');
        </script>

        <script type="text/javascript">
        $(function () {
            $('[data-toggle="tooltip"]').tooltip({ placement: 'bottom'})
        })
        </script>

        <!-- define equivalent circuit -->
        <script type="text/javascript">
        function ecdefine() {
            if($('#ecinput').is(':checked')) {
                document.getElementById('ecmodal').click();
            }
        }
        </script>

        <!-- draw chart with d3 -->
        <script type="text/javascript" src="{{ url_for('static', filename='nyquist-models.js') }}"> </script>

        <script type="text/javascript">
            var data = {{ data|tojson|safe }}; // 1 x N frequencys Array of 1 x 3 arrays (real, imag, freq)
            if (data == 0) {
                d3.select('#nyquist')
            	.append('div')
            	.text('<-- Upload a file')
            } else {
                var ecmodel = {{ ecFit|tojson|safe }};
                var p2dmodel = {{ p2dFit|tojson|safe }};

                var nyquist = nyquistChart({width: 400, height: 400, ec: ecmodel, p2d: p2dmodel})
                    .x(function(d) { return d[1] })
                    .y(function(d) { return -d[2] });

                d3.select("#nyquist")
                    .datum(data)
                    .call(nyquist);

            }
        </script>

        <!-- draw bode plot  with d3 -->
        <script type="text/javascript">
            var data = {{ data|tojson|safe }}; // 1 x N frequencys Array of 1 x 3 arrays (real, imag, freq)

            function phase(real, imag) {
                return Math.atan2(imag,real)*180/Math.PI;
            }

            function mag(real, imag) {
                return Math.sqrt(Math.pow(imag, 2) + Math.pow(real, 2));
            }

            if (data == 0) {
                d3.select('#bode')
            	.append('div')
            	.text('<-- Upload a file')
            } else {
                var ecmodel = {{ ecFit|tojson|safe }};
                var p2dmodel = {{ p2dFit|tojson|safe }};

                outerWidth = 400;
                outerHeight = 400;

                var margin = {top: 10, right: 10, bottom: 60, left: 60};
                var width = outerWidth - margin.left - margin.right;
                var height = outerHeight/2 - margin.top - margin.bottom;

                var xScale_ph = d3.scale.log()
                var yScale_ph = d3.scale.linear()

                var xScale_mag = d3.scale.log()
                var yScale_mag = d3.scale.log()

                var xAxis_ph = d3.svg.axis()
                    .scale(xScale_ph)
                    .ticks(5)
                    .orient('bottom');

                var yAxis_ph = d3.svg.axis()
                    .scale(yScale_ph)
                    .ticks(5)
                    .orient('left');

                var xAxis_mag = d3.svg.axis()
                    .scale(xScale_mag)
                    .ticks(5)
                    .orient('bottom');

                var yAxis_mag = d3.svg.axis()
                    .scale(yScale_mag)
                    .ticks(5)
                    .orient('left');

                xScale_ph
                    .range([0, width])
                    .domain(d3.extent(data, function(d, i) { return d[0]} ));

                yScale_ph
                    .range([height, 0])
                    .domain([0, d3.min(data, function(d, i) { return phase(d[1], d[2])} )]);

                xScale_mag
                    .range([0, width])
                    .domain(d3.extent(data, function(d, i) { return d[0]} ));

                yScale_mag
                    .range([height, 0])
                    .domain(d3.extent(data, function(d, i) { return mag(d[1], d[2])} ))
                    .nice();

                // Select the svg element, if it exists.
                var svg_ph = d3.select('#bode').append("svg").attr("id", "phase")
                var svg_mag = d3.select('#bode').append("svg").attr("id", "magnitude")

                // add the tooltip area to the webpage
                var tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);

                var plot_ph = svg_ph.append("g");
                var plot_mag = svg_mag.append("g");

                plot_ph.append("g").attr("class", "x axis");
                plot_ph.append("g").attr("class", "y axis");

                plot_mag.append("g").attr("class", "x axis");
                plot_mag.append("g").attr("class", "y axis");

                // Update the outer dimensions.
                svg_ph
                    .attr("width", outerWidth)
                    .attr("height", outerHeight/2);

                svg_mag
                    .attr("width", outerWidth)
                    .attr("height", outerHeight/2);

                var g_ph = svg_ph.select("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var g_mag = svg_mag.select("g")
                    .attr("transform", "translate(" + margin.left + "," + (margin.top) +  ")");

                g_ph.select(".x.axis")
                    .attr('transform', 'translate(0,' + height + ')')
                    .call(xAxis_ph)

                g_ph.select(".y.axis")
                    .attr('transform', 'translate(0,' + 0 + ')')
                    .call(yAxis_ph)

                g_mag.select(".x.axis")
                    .attr('transform', 'translate(0,' + height + ')')
                    .call(xAxis_mag)

                g_mag.select(".y.axis")
                    .attr('transform', 'translate(0,' + 0 + ')')
                    .call(yAxis_mag)

                g_ph.append("text")
                    .attr("class", "label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left)
                    .attr("x",0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("-Phase");

                g_mag.append("text")
                    .attr("class", "label")
                    .attr("transform", "translate(" + (width/2) + " ," +
                                                    (height + margin.top + 20) + ")")
                    .style("text-anchor", "middle")
                    .text("Frequency");

                g_mag.append("text")
                    .attr("class", "label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left)
                    .attr("x",0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("Magnitude");

                var phases = g_ph.selectAll("circle").data(data);

                phases.enter().append('circle');
                phases
                    .attr("class", "default-circle")
                    .attr("cx", function (d) { return xScale_ph( d[0] ); } )
                    .attr("cy", function (d) { return yScale_ph( phase(d[1], d[2]) ); } )
                    .attr("r", 5)
                    .on("mouseover", function(d,i) {
                        d3.select(this)
                            .classed("selected-circle", true)
                            .attr("r", 10);

                        g_mag.selectAll("circle")
                            .data(data)
                            .classed("selected-circle", function(d2, i2) {return i2 == i; })
                            .attr("r", function(d2, i2) { if(i2 == i) { return 10; } else { return 5;} });

                        d3.select("#nyquist").selectAll("circle")
                            .data(data)
                            .classed("selected-circle", function(d2, i2) {return i2 == i; })
                            .attr("r", function(d2, i2) { if(i2 == i) { return 10; } else { return 5;} });

                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);

                        tooltip.html('Freq: ' + Math.round(d[0]*1000)/1000 + "<br/>"  +
                                            'Phase: ' + Math.round(phase(d[1], d[2])*1000)/1000)
                                            .style("left", (d3.event.pageX + 20) + "px")
                                            .style("top", (d3.event.pageY - 50) + "px");

                    })
                    .on("mouseout", function(d,i) {
                        d3.select(this)
                            .attr("class", "default-circle")
                            .attr("r", 5);

                        g_mag.selectAll("circle")
                            .data(data)
                            .attr("class", "default-circle")
                            .attr("r", 5);

                        d3.select("#nyquist").selectAll("circle")
                            .data(data)
                            .attr("class", "default-circle")
                            .attr("r", 5);
                    });

                var mags = g_mag.selectAll("circle").data(data);

                mags.enter().append('circle');
                mags
                    .attr("class", "default-circle")
                    .attr("cx", function (d) { return xScale_mag( d[0] ); } )
                    .attr("cy", function (d) { return yScale_mag( mag(d[1], d[2]) );  } )
                    .attr("r", 5)
                    .on("mouseover", function(d,i) {
                        d3.select(this)
                            .classed("selected-circle", true)
                            .attr("r", 10);

                        // console.log(phases);
                        g_ph.selectAll("circle")
                            .data(data)
                            .classed("selected-circle", function(d2, i2) {return i2 == i; })
                            .attr("r", function(d2, i2) { if(i2 == i) { return 10; } else { return 5;} });

                        d3.select("#nyquist").selectAll("circle")
                            .data(data)
                            .classed("selected-circle", function(d2, i2) {return i2 == i; })
                            .attr("r", function(d2, i2) { if(i2 == i) { return 10; } else { return 5;} });

                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);

                        tooltip.html('Freq: ' + Math.round(d[0]*1000)/1000 + "<br/>"  +
                                            'Mag: ' + Math.round(mag(d[1], d[2])*1000)/1000)
                                            .style("left", (d3.event.pageX + 20) + "px")
                                            .style("top", (d3.event.pageY - 50) + "px");

                    })
                    .on("mouseout", function(d,i) {
                        d3.select(this)
                            .attr("class", "default-circle")
                            .attr("r", 5);

                        g_ph.selectAll("circle")
                            .data(data)
                            .attr("class", "default-circle")
                            .attr("r", 5);

                        d3.select("#nyquist").selectAll("circle")
                            .data(data)
                            .attr("class", "default-circle")
                            .attr("r", 5);

                    });

            }
        </script>

    </body>
</html>
